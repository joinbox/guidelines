# GET /Joinbox/RESTful/Style/Guide

This styleguide describes how RESTful services should be designed @joinbox. All services should make use of the same custom and standard headers, status codes an request methods so that all services can interact without any custom code.

Most of the functionality will be handled by the ee framework.


## Naming 

- **Collection**: A collection is a collection of resources like users, events or venues
- **Resource**: A resource is a single item of a collection, like one event or one user
- **Request**: Method: A HTTP request method: GET, POST, DELETE, OPTIONS, HEAD, PUT, PATCH
- **Headers**: Stadard HTTP request / response headers 
- **Body**: HTTP request / response body
- **Status**: HTTP response status code like 200, 400 or 500



## URLs

Every entity is a collection and can be accessed through an URL. The URL consits of a descriptive name of the entity. You should always use the singular form for a collection name.

**Bad**
- /Users
- /EventboosterUsers

**Good**
- /user


Resources must be made available throught an URL consisting of the collection, a slash and a unique resource identifier.

**Bad**
- /Users/byId/1
- /User1

**Good**
- /user/1
- /user/michael%40joinbox.com


A resource may have as many subresources / subcollections as required, the URL for the subresource must follow the same rules as the collection / resource it depends on. Since subresources are basically mappings they can be made avialable as subresource or a separate resource or as both.

**Bad**
- /user/1/comment
- /user/1/usercomments/3

**Good**
- /user/1/comment
- /user/1/comment/34





## Headers

### Request Haders

The following list of headers should automatically be generated by the application framework you are using on both side of the connection:
- **Content-Length**: actual payload length
- **Connection**: kep alive / close
- **Accept-Encoding**: compression


#### Accept

The content type that can be accepted, will be «Application/JSON» most of the time.
If the server cannot satisfy the request he will respond with the **406 - Not Acceptable** status.

```HTTP
GET /user HTTP/1.1
Accept: Application/JSON
```


#### Accept-Language

The requested content language. Most of the time this will be one of en, de, fr, it.
If the server cannot satisfy the request he will respond with the **406 - Not Acceptable** status.


Since all language specific data is stored in mapping tables between the entity and the language entity it is **not** required to submit the header. You can instead use the «Select» and «Filter» header for selecting the language data. If you use the «Accept-Language» header the service will return the resource in that specific language with the locale data included into the entity. If you use the «Select» header without the «Filter» header the service will return all locale records. Without the «Accept-Language» header the locale data will be returned, if selected, like all mappings inside an array. See the [Locale Data]() Section.

```HTTP
GET /user HTTP/1.1
Accept-Language: de, fr;q=0.9, en;q=0.8
```


#### Content-Language

Used for POST / PATCH & PUT request. Specifies the language in which the content is delivered in.


```HTTP
GET /user HTTP/1.1
Content-Language: de, fr;q=0.9, en;q=0.8
```



#### Range

0 based range index, supported by most collections. Only available if the options request did return the «Accept-Ranges: resources» header
If the server cannot satisfy the request he will respond with the **416 - Requested Range Not Satisfiable** status.

```HTTP
GET /user HTTP/1.1
Range: 0-9
```


#### Content-Type

The content type of the payload on requests with body ( POST, PATCH, PUT ). Will most of the time be «Multipart/Form-Data»

```HTTP
GET /user HTTP/1.1
Content-Type: Multipart/Form-Data
```


#### Select

Custom headers for selecting data from resources / sub resources. The headers content must be delivered as comma separated list. Fields of sub entities may be selected using the «.» ( dot ). 
If the server cannot satisfy the request he will respond with the **460 - Select Not Satisfiable** status.


```HTTP
GET /user HTTP/1.1
Select: id, name, tenant.id, tenant.name, friend.name, friend.id
```


#### Filter

Custom header used for filtering collections. The filters consist of a comma separated list of keys and values. String values in the value part of the key-value pairs must be url encoded. This must not include the function name or operator. Strings must be enclosed in quotation marks.
If the server cannot satisfy the request he will respond with the **461 - Filter Not Satisfiable** status.

```HTTP
GET /user HTTP/1.1
Filter: id=in(3,4), firstName=like('mich%25')
```


#### Order

Custom header for defining the order in which the results must be returned. The complete collection is ordered before a range from it is returned in the requested order.
If the server cannot satisfy the request he will respond with the **462 - Ordering Not Satisfiable** status.

```HTTP
GET /user HTTP/1.1
Order: name, firends.name DESC
```


#### API-Version

The API version to use to respond to requests
If the server cannot satisfy the request he will respond with the **463 - Unsupported API Version** status.

```HTTP
GET /user HTTP/1.1
API-Version: 0.0.1
```


### Response Headers

#### Content-Type

The Content Type of the response, will almost always be «Application/JSON».


```HTTP
HTTP/1.1 200 OK
Content-Type: Application/JSON
```


#### Range

Zero based resource range index. Describes the offset and length of the resources returned to the client. If the client did not specify a range the starting page of the range will be returned.

The range & accept-range header must be sent in response to all GET & HEAD requests on a collection. If the server cannot satisfy the request he will respond with the **416 - Requested Range Not Satisfiable** status.

```HTTP
HTTP/1.1 200 OK
Accept-Ranges: resources
Content-Range: 0-9/5604
```


#### Content-Language

If the reqeust contained an «Accept-Language» header the resource(s) will be returned using the selected language an the «Content-Language» header will be set. 

```HTTP
HTTP/1.1 200 OK
Content-Language: en
```



## Methods

The following methods may be made available on collections

- OPTIONS
- GET
- HEAD
- POST
- DELETE

### GET

The GET method is used to get an optional filtered, paged set of resources. 


**Mandatory Request Headers**
- Accept
- API-Version

**Optional Request Headers**
- Accept-Language
- Range
- Select
- Order
- Filter

**Mandatory Response Headers**
- Accept-Ranges
- Content-Range
- Content-Length
- Date

**Optional Response Headers**
- Content-Language


**Example**

The example request does the following
- return the users property «id», the related tenants properties «id» and «name» and the related friends properties «id» and «name»
- filter the user by id ( in 3, 4 ) and name ( like micha% ), see [filters]()
- limit the result count to 10, starting at offset 0
- return the data in german

*Request Headers*
```HTTP
GET /user HTTP/1.1
Host: somehost:12001
Accept: Application/JSON
Accept-Language: de, fr;q=0.9, en;q=0.8
Range: 0-9
Select: id, tenant.id, tenant.name, friends.id, friends.name
Order: name DESC, firends.name DESC
Filter: id=in(3,4), firstName=like('mich%25')
API-Version: 0.0.1
```

*Response Headers*
```HTTP
HTTP/1.1 200 OK
Content-Type: Application/JSON
Date: Fri, 15 Nov 2013 12:12:14 GMT
Content-Language: de
Range: 0-10
```

*Response Body*
```Javascript
[
	{
		  id: 4
		, name: "michael"
		, tenant: {
			  id: 1
			, name: "default tenant"
			, _rel: {
				  _self: 		"/tenant/1"
				, _collection: 	"/tenant"
				, _mapping: 	"/user/4/tenant/1"
			}
		}
		, friend: [
			{
				  id: 5 
				, name: "pereg"
				, _rel: {
					  _self: 		"/user/5"
					, _collection: 	"/user"
					, _mapping: 		"/user/4/friend/5"
				}
			}
			, {
				  id: 4
				, name: "fabian"
				, _rel: {
					  _self: 		"/user/4"
					, _collection: 	"/user"
					, _mapping: 		"/user/4/friend/4"
				}
			}
		]
		, _rel: {
			  _self: 		"/user/4"
			, _collection: 	"/user"
			, friend: 		"/user/4/friend"
			, tenant: 		"/user/4/tenant"
			, city: 		"/user/4/city"
		}
	}
	, {
		  id: 3
		, name: "micha"
		, tenant: {
			  id: 4
			, name: "events.ch"
			, _rel: {
				  _self: 		"/tenant/4"
				, _collection: 	"/tenant"
				, _mapping: 	"/user/3/tenant/4"
			}
		}
		, friends: []
		, _rel: {
			  _self: 		"/user/3"
			, _collection: 	"/user"
			, friend: 		"/user/3/friend"
			, tenant: 		"/user/3/tenant"
			, city: 		"/user/3/city"
		}
	}
]
```


### POST

Adds a new item to the collection automatically creating an id for the new resource. The created resource will be returned.

**Mandatory Request Headers**
- Accept
- Content-Language
- API-Version
- Content-Type

**Optional Request Headers**
- Select

**Mandatory Response Headers**
- Content-Language
- Content-Length
- Date
- Location

**Example**

The example request does the following
- insert a new item in the colelction «user» with a new automatically created id
- return the resource with the sub resources according to the «Select» header

*Request Headers*
```HTTP
POST /user HTTP/1.1
Host: somehost:12001
Accept: Application/JSON
Content-Type: Multipart/Form-Data
Content-Language: en
Select: id, tenant.id, tenant.name, friends.id, friends.name
API-Version: 0.0.1
```

*Response Headers*
```HTTP
HTTP/1.1 201 OK
Content-Type: Application/JSON
Date: Fri, 15 Nov 2013 12:12:14 GMT
Content-Language: en
Location: /user/7
```

*Response Body*
```Javascript
{
	  id: 7
	, name: "tobias"
	, tenant: {
		  id: 4
		, name: "events.ch"
		, _rel: {
			  _self: 		"/tenant/4"
			, _collection: 	"/tenant"
			, _mapping: 	"/user/7/tenant/4"
		}
	}
	, friends: []
	, _rel: {
		  _self: 		"/user/7"
		, _collection: 	"/user"
		, friend: 		"/user/7/friend"
		, tenant: 		"/user/7/tenant"
		, city: 		"/user/7/city"
	}
}
```


## Methods available on resources

The following methods may be made available on collections
- GET
- HEAD
- PUT
- PATCH
- DELETE

### GET

**Mandatory Request Headers**
- Accept
- API-Version

**Optional Request Headers**
- Accept-Language
- Select

**Mandatory Response Headers**
- Content-Length
- Date

**Optional Response Headers**
- Content-Language

**Example**
The example request will do the following:
- return the users property «id», the related tenants properties «id» and «name» and the related friends properties «id» and «name»
- return the data in all languages

*Request Headers*
```HTTP
GET /user HTTP/1.1
Host: somehost:12001
Accept: Application/JSON
Select: id, tenant.id, tenant.name, friends.id, friends.name, city.zip, city.name
API-Version: 0.0.1
```

*Response Headers*
```HTTP
HTTP/1.1 200 OK
Content-Type: Application/JSON
Date: Fri, 15 Nov 2013 12:12:14 GMT
```

*Response Body*
```Javascript
{
	  id: 3
	, name: "micha"
	, city: {
		  zip: 3011
		, name: [
			{ 
			  	  language: "de"
			  	, name: "Bern" 
			  	, _rel: {
					  _self: 		"/language/48"
					, _collection: 	"/language"
					, _mapping: 	"/city/3847/language/2"
				}
			}
			, { 
			  	  language: "en"
			  	, name: "Bern" 
			  	, _rel: {
					  _self: 		"/language/48"
					, _collection: 	"/language"
					, _mapping: 	"/city/3847/language/1"
				}
			}
			, { 
			  	  language: "it"
			  	, name: "Berna" 
			  	, _rel: {
					  _self: 		"/language/48"
					, _collection: 	"/language"
					, _mapping: 	"/city/3847/language/4"
				}
			}
			, { 
			  	  language: "fr"
			  	, name: "Berne" 
			  	, _rel: {
					  _self: 		"/language/48"
					, _collection: 	"/language"
					, _mapping: 	"/city/3847/language/3"
				}
			}
		]
		, _rel: {
			  _self: 		"/city/48"
			, _collection: 	"/city"
			, _mapping: 	"/user/3/city/48"
		}
	}
	, tenant: {
		  id: 4
		, name: "events.ch"
		, _rel: {
			  _self: 		"/tenant/4"
			, _collection: 	"/tenant"
			, _mapping: 	"/user/3/tenant/4"
		}
	}
	, friends: []
	, _rel: {
		  _self: 		"/user/3"
		, _collection: 	"/user"
		, friend: 		"/user/3/friend"
		, tenant: 		"/user/3/tenant"
		, city: 		"/user/3/city"
	}
}
```


### DELETE

**Mandatory Request Headers**
- API-Version
- Accept
- Select

**Optional Request Headers**
- Content-Language

**Mandatory Response Headers**
- Content-Length
- Date

**Optional Response Headers**
- Content-Language


**Example**

Deletes an user, returns the deleted user

*Request Headers*
```HTTP
DELETE /user HTTP/1.1
Host: somehost:12001
Accept: Application/JSON
Select: id, name
API-Version: 0.0.1
```

*Response Headers*
```HTTP
HTTP/1.1 200 OK
Content-Type: Application/JSON
Date: Fri, 15 Nov 2013 12:12:14 GMT
```

*Response Body*
```Javascript
{
	  id: 3
	, name: "micha"
	, _rel: {
		  _self: 		"/user/3"
		, _collection: 	"/user"
		, friend: 		"/user/3/friend"
		, tenant: 		"/user/3/tenant"
		, city: 		"/user/3/city"
	}
}
```


### PUT

Adds a new item to the collection or overwrites an existing one. The created resource will be returned.

**Mandatory Request Headers**
- Accept
- Content-Language
- API-Version
- Content-Type

**Optional Request Headers**
- Select

**Mandatory Response Headers**
- Content-Language
- Content-Length
- Date
- Location

**Example**

The example request does the following
- insert a new item in the collection «user». Overwriting an existing resource if there is one with the same id
- return the resource with the sub resources according to the «Select» header

*Request Headers*
```HTTP
PUT /user/7 HTTP/1.1
Host: somehost:12001
Accept: Application/JSON
Content-Type: Multipart/Form-Data
Content-Language: en
Select: id, tenant.id, tenant.name, friends.id, friends.name
API-Version: 0.0.1
```

*Response Headers*
```HTTP
HTTP/1.1 201 OK
Content-Type: Application/JSON
Date: Fri, 15 Nov 2013 12:12:14 GMT
Content-Language: en
Location: /user/7
```

*Response Body*
```Javascript
{
	  id: 7
	, name: "tobias"
	, tenant: {
		  id: 4
		, name: "events.ch"
		, _rel: {
			  _self: 		"/tenant/4"
			, _collection: 	"/tenant"
			, _mapping: 	"/user/7/tenant/4"
		}
	}
	, friends: []
	, _rel: {
		  _self: 		"/user/7"
		, _collection: 	"/user"
		, friend: 		"/user/7/friend"
		, tenant: 		"/user/7/tenant"
		, city: 		"/user/7/city"
	}
}
```



### PATCH

Updates an existing item.

**Mandatory Request Headers**
- Accept
- Content-Language
- API-Version
- Content-Type

**Optional Request Headers**
- Select

**Mandatory Response Headers**
- Content-Language
- Content-Length
- Date
- Location

**Example**

The example request does the following
- updates an existing resource.
- return the resource with the sub resources according to the «Select» header

*Request Headers*
```HTTP
PATCH /user/7 HTTP/1.1
Host: somehost:12001
Accept: Application/JSON
Content-Type: Multipart/Form-Data
Content-Language: en
Select: id, tenant.id, tenant.name, friends.id, friends.name
API-Version: 0.0.1
```

*Response Headers*
```HTTP
HTTP/1.1 201 OK
Content-Type: Application/JSON
Date: Fri, 15 Nov 2013 12:12:14 GMT
Content-Language: en
Location: /user/7
```

*Response Body*
```Javascript
{
	  id: 7
	, name: "tobias"
	, tenant: {
		  id: 4
		, name: "events.ch"
		, _rel: {
			  _self: 		"/tenant/4"
			, _collection: 	"/tenant"
			, _mapping: 	"/user/7/tenant/4"
		}
	}
	, friends: []
	, _rel: {
		  _self: 		"/user/7"
		, _collection: 	"/user"
		, friend: 		"/user/7/friend"
		, tenant: 		"/user/7/tenant"
		, city: 		"/user/7/city"
	}
}
```




## The OPTIONS Method

The options request returns information about methods and headers that can be used on the given collection / resource.


*Request Headers*
```HTTP
OPTIONS /user HTTP/1.1
Host: somehost:12001
Accept: Application/JSON
```

*Response Headers*
```HTTP
HTTP/1.1 200 OK
Content-Type: Application/JSON
Date: Fri, 15 Nov 2013 12:12:14 GMT
Allow: OPTIONS,GET,POST
Accept-Ranges: resources
Accept-Select: *, tenant.*, friends.*
Accept-Order: *
Accept-Filter: id, tenant.id
```

*Response Body*

The data in the response body describes the collection / resource and the subresources of the collection / resource
```Javascript
{
	  allow: ['OPTIONS','GET','POST']
	, resource: {
		id: { 
		  	  primary: 	true
		  	, type: 	'int'
		  	, filters: 	'numbers'
		}
		, tenant: {
			id: { 
			  	  primary: 	true
			  	, type: 	'int'
			  	, filters: 	'numbers'
			}
			, name: {
				  unique: 	true
			  	, type: 	'string'
			  	, filters: 	'strings'
			}
		}
	}
	, filters: {
		  numbers: ['<', '>', '=', '!=', '>=', '<=', 'notNull', 'null', 'in']
		, strings: ['=', '!=', 'like', 'notNull', 'null', 'in']
	}
}
```


## Filters

The filter described below may be supported by any collection. You may combine as many filters as you like. If you filter one property with mutliple filters the filters will be evaluated using the logical «and» oberator. If you want to use multiple filters using the «or» operator you must define them in multiple «Filter» headers.


### Numbers

```HTTP
Filter: id=1
Filter: id!=1
Filter: id>=1
Filter: id<=1
Filter: id>1
Filter: id<1
Filter: id=in(1,2,3,4)
Filter: id=null
Filter: id=notNull
```

### Strings
```HTTP
Filter: name=fabian
Filter: name!=felix
Filter: name=in('fabian, 'michael')
Filter: name=like('fabi*')
Filter: name=null
Filter: name=notNull
```

### Booleans
```HTTP
Filter: deleted=false
Filter: deleted=true
Filter: deleted=null
Filter: name=notNull
```

### Date

date properties may be filtered using the following format: «YYYY-MM-DD HH:MM:SS». You may omit any part from the right to the left, so is «YYYY-MM-DD HH» the equivalent of «YYYY-MM-DD HH:00:00» and «YYYY» is the equivalent of «YYYY-00-00 00:00:00».

```HTTP
Filter: created=2013-11-18 
Filter: created!=2013-11-18
Filter: created>=2013-11-18 20:00:02
Filter: created<=2013-11-18
Filter: created>2013-11-18
Filter: created<2013-11-18
Filter: created=in(2013,2014)
Filter: created=null
Filter: created=notNull
```